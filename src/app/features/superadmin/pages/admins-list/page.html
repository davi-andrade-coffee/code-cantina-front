<div class="flex flex-wrap items-center justify-between gap-3 mb-4">
  <div>
    <h1 class="text-lg font-semibold">Admins</h1>
    <p class="text-sm opacity-70">
      Gerencie os clientes do sistema, bloqueios e status de cobrança.
    </p>
  </div>

  <div class="flex items-center gap-2">
    <button class="btn btn-primary btn-sm" (click)="abrirCadastro()">Novo Admin</button>
  </div>
</div>

<div class="tabs tabs-boxed mb-4">
  <button class="tab" [class.tab-active]="activeTab() === 'LISTA'" (click)="activeTab.set('LISTA')">
    Listagem
  </button>
  <button
    class="tab"
    [class.tab-active]="activeTab() === 'INSIGHTS'"
    (click)="activeTab.set('INSIGHTS')"
  >
    Insights
  </button>
</div>

<ng-container *ngIf="activeTab() === 'LISTA'; else insightsView">
  <superadmin-table-card title="Admins cadastrados" subtitle="Controle de acesso e cobrança por cliente.">
    <div table-actions class="flex flex-wrap items-center gap-2">
      <label class="form-control w-full max-w-[220px]">
        <div class="label">
          <span class="label-text text-xs opacity-70">Buscar</span>
        </div>
        <input
          class="input input-bordered input-sm"
          placeholder="Nome, e-mail, documento"
          [value]="filtros().termo"
          (input)="patchFiltro({ termo: $any($event.target).value })"
        />
      </label>

      <label class="form-control w-full max-w-[160px]">
        <div class="label">
          <span class="label-text text-xs opacity-70">Status</span>
        </div>
        <select
          class="select select-bordered select-sm"
          [value]="filtros().status"
          (change)="patchFiltro({ status: $any($event.target).value })"
        >
          <option value="TODOS">Todos</option>
          <option value="ATIVO">Ativo</option>
          <option value="BLOQUEADO">Bloqueado</option>
        </select>
      </label>

      <label class="form-control w-full max-w-[180px]">
        <div class="label">
          <span class="label-text text-xs opacity-70">Inadimplência</span>
        </div>
        <select
          class="select select-bordered select-sm"
          [value]="filtros().somenteInadimplentes ? 'SIM' : 'NAO'"
          (change)="patchFiltro({ somenteInadimplentes: $any($event.target).value === 'SIM' })"
        >
          <option value="NAO">Todos</option>
          <option value="SIM">Somente inadimplentes</option>
        </select>
      </label>

      <button class="btn btn-primary btn-sm mt-6" (click)="buscar()" [disabled]="loading()">
        <span *ngIf="!loading()">Buscar</span>
        <span *ngIf="loading()" class="loading loading-spinner loading-xs"></span>
      </button>
    </div>

    <div *ngIf="errorMsg()" class="alert alert-error mb-4">
      <span class="text-sm">{{ errorMsg() }}</span>
    </div>

    <div class="overflow-x-auto">
      <table class="table table-zebra table-sm">
        <thead>
          <tr>
            <th>Admin</th>
            <th>Documento</th>
            <th>Lojas</th>
            <th>Status</th>
            <th>Último pagamento</th>
            <th>Ações</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let admin of paginaAdmins()">
            <td>
              <div class="font-semibold">{{ admin.nome }}</div>
              <div class="text-xs opacity-70">{{ admin.email }}</div>
            </td>
            <td class="text-sm">{{ admin.documento }}</td>
            <td>
              <div class="text-sm">{{ admin.lojasAtivas }} ativas / {{ admin.lojasTotal }} total</div>
            </td>
            <td>
              <superadmin-status-badge [status]="admin.status" kind="admin"></superadmin-status-badge>
              <div *ngIf="admin.inadimplente" class="text-xs text-error mt-1">Inadimplente</div>
            </td>
            <td class="text-sm">{{ admin.ultimoPagamento }}</td>
            <td>
              <div class="flex flex-wrap gap-2">
                <a class="btn btn-ghost btn-xs" [routerLink]="['/superadmin/admins', admin.id]">
                  Detalhes
                </a>
                <button class="btn btn-ghost btn-xs" (click)="abrirBloqueio(admin)">Bloquear</button>
                <button class="btn btn-ghost btn-xs">Desbloquear</button>
              </div>
            </td>
          </tr>

          <tr *ngIf="!loading() && paginaAdmins().length === 0">
            <td colspan="6" class="text-center opacity-70 py-6">
              Nenhum Admin encontrado para os filtros selecionados.
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <superadmin-pagination
      [page]="paginaAtual()"
      [totalPages]="totalPaginas()"
      [totalItems]="admins().length"
      [pageItems]="paginaAdmins().length"
      [pageSize]="itensPorPagina()"
      [pageSizes]="tamanhosPagina"
      (pageChange)="alterarPagina($event)"
      (pageSizeChange)="setItensPorPagina($event)"
    ></superadmin-pagination>
  </superadmin-table-card>
</ng-container>

<ng-template #insightsView>
  <div class="grid gap-4">
    <div class="grid gap-4 md:grid-cols-3">
      <superadmin-kpi-card
        label="Total de Admins"
        [value]="insights()?.total ?? '—'"
        hint="Clientes cadastrados na base"
      ></superadmin-kpi-card>
      <superadmin-kpi-card
        label="Admins ativos"
        [value]="insights()?.ativos ?? '—'"
        hint="Em operação"
      ></superadmin-kpi-card>
      <superadmin-kpi-card
        label="Admins bloqueados"
        [value]="insights()?.bloqueados ?? '—'"
        hint="Com bloqueio ativo"
      ></superadmin-kpi-card>
    </div>

    <div class="grid gap-4 md:grid-cols-3">
      <superadmin-kpi-card
        label="Receita estimada (mês)"
        [value]="insights()?.receitaEstimadaMes ? ('R$ ' + insights()?.receitaEstimadaMes) : '—'"
        hint="Base: lojas ativas"
      ></superadmin-kpi-card>
      <superadmin-kpi-card
        label="Inadimplentes"
        [value]="insights()?.inadimplentes ?? '—'"
        hint="Admins com fatura vencida"
      ></superadmin-kpi-card>
      <superadmin-kpi-card
        label="Taxa de inadimplência"
        [value]="formatPercent(insights()?.inadimplenciaPercentual)"
        hint="Percentual sobre a base"
      ></superadmin-kpi-card>
    </div>

    <div class="grid gap-4 md:grid-cols-2">
      <div class="rounded-xl border border-base-100 bg-base-200 p-4">
        <h3 class="text-sm font-semibold mb-2">Admins por status</h3>
        <div class="space-y-2 text-sm">
          <div class="flex items-center justify-between">
            <span>Ativos</span>
            <span class="font-semibold">{{ insights()?.ativos ?? 0 }}</span>
          </div>
          <progress class="progress progress-success" [value]="insights()?.ativos ?? 0" [max]="insights()?.total ?? 1"></progress>
          <div class="flex items-center justify-between">
            <span>Bloqueados</span>
            <span class="font-semibold">{{ insights()?.bloqueados ?? 0 }}</span>
          </div>
          <progress class="progress progress-error" [value]="insights()?.bloqueados ?? 0" [max]="insights()?.total ?? 1"></progress>
        </div>
      </div>

      <div class="rounded-xl border border-base-100 bg-base-200 p-4">
        <h3 class="text-sm font-semibold mb-2">Novos Admins por mês</h3>
        <div class="space-y-3">
          <div *ngFor="let item of insights()?.novosPorMes" class="flex items-center justify-between text-sm">
            <span>{{ item.mes }}</span>
            <div class="flex items-center gap-2">
              <progress class="progress progress-primary w-32" [value]="item.total" [max]="6"></progress>
              <span class="font-semibold">{{ item.total }}</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</ng-template>

<superadmin-block-modal
  [open]="modalBloqueioAberto()"
  [title]="'Bloquear Admin ' + (adminSelecionado()?.nome ?? '')"
  subtitle="O bloqueio será aplicado a todas as lojas vinculadas."
  (close)="fecharBloqueio()"
  (confirm)="confirmarBloqueio()"
></superadmin-block-modal>

<superadmin-create-admin-modal
  [open]="modalCadastroAberto()"
  (close)="fecharCadastro()"
  (confirm)="confirmarCadastro()"
></superadmin-create-admin-modal>
